<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>What's Up with Testing</title>
    <link rel="author" title="dzenana" href="mailto:dzenana.trenutak@gmail.com">
    <style>
        body {margin: 1em 1em 2em 16em; font-family: sans-serif; }

        #navigation { float: left; width: 13em; margin: 0 0 0 -15em; position: fixed; padding: 0.5em;
                      background-color: #aaa; border-radius: 0.5em; }
        #navigation ul { list-style-type: none; padding-left: 0.5em; }
        #navigation ul ul li:before { content: "- "; }

        #main { max-width: 60em; }
        .todo {background-color: yellow;}
        #main nav { margin-top: 3em; text-align: center; }
        #main nav a { padding-right: 3em; }

        pre.idl { margin-left: 5em; white-space: pre-wrap; }
        pre.idl { border: solid thin; background: #EEEEEE; color: black; padding: 0.5em 1em; position: relative; }
        pre.idl :link, pre.idl :visited { color: inherit; background: transparent; }
        pre.idl::before { content: "IDL"; font: bold small sans-serif; padding: 0.5em; background: white; position: absolute; top: 0; margin: -1px 0 0 -4em; width: 1.5em; border: thin solid; border-radius: 0 0 0 0.5em }

        /* wide screen */
        @media all and (min-width: 90em)
        {
          body {margin: 4em 4em 4em 20em; }
        }

        /* Narrow screen */
        @media all and (max-width: 50em)
        {
          body { margin: 1em; }
          #navigation { float: none; position: static; margin-left: auto; margin-right: auto; }
          #main nav a { display: block; }
        } 
    </style>
</head>
<body>

<h1>Example Test: WebIDL</h1>


<section id="navigation">

    <h4>Tutorial</h4>
    <nav>
    <ul>
    <li><a href="index.html">Overview</a></li>   
    <li><a href="Need.html">What You'll Need</a></li>
    <li><a href="WhichAndHowMany.html">Which Tests to Write</a></li>
    <li><a href="Writing.html">Writing Tests</a>
     <ul>
       <li><a href="ExampleTest_WebIDL.html">WebIDL example</a></li>
       <li><a href="ExampleTest_Auto.html">JavaScript example</a></li>
       <li><a href="ExampleTest_RefTest.html">RefTest example</a></li>
       <li><a href="ExampleTest_Manual.html">Manual example</a></li>
     </ul>
    </li>
    <li><a href="Submitting.html">Submitting Tests</a></li>
    <li><a href="ThenWhat.html">Test Review Process</a></li>
    </ul>
    </nav>

   <h4>Test Templates</h4>
   <ul>
    <li><a href="templates/template-webIDL.html">WebIDL test</a></li>
    <li><a href="templates/template-auto.html">JavaScript test</a></li>
    <li><a href="templates/template-reftest-001.html">RefTest, first half</a></li>
    <li><a href="templates/template-reftest-001-ref.html">RefTest, second half</a></li>
    <li><a href="templates/template-MANUAL.html">Manual test</a></li>
   </ul>
</section>

<div id="main">

<p>As you progress through the spec you are testing, you will often see a box at the beginning a section that contains WebIDL.  You will need to test this WebIDL in addition to testing all the "normative statements" and other "candidate requirements" that you find within the text for that section.</p>

<p>Testing the WebIDL makes sure that user agents really have the nitty-gritty right when it comes to implementing the various HTML elements.  Like that, low-level inconsistencies are flushed out so that high-level applications will be able to enjoy the benefits of true standardization!</p>

<p>To test WebIDL, you will need to fit a few pieces together: the <b>WebIDL to test</b>, some <b>WebIDL not to test</b>, and a <b>sample object</b> to bring that WebIDL to life.</p>

<p>The <b>WebIDL to test</b> is the WebIDL you have just found in the section of the spec that you are testing.  If you relate WebIDL testing to following an architect's plan, you could imagine this part as providing the blueprint for the outside of a skyscraper.</p>

<p>The <b>WebIDL not to test</b> is all of the WebIDL that forms the tested WebIDL's inheritance chain (looking at all attributes and methods as well as at prototypes).  Following the architectural parallel, you can imagine this part as all of the blueprints needed to have built the inside of the skyscraper (without which there could be no outside), as well as any supplementary blueprints needed to describe pre-fabricated, ready-to-assemble bits that belong on the outside.</p>

<p>The <b>sample object</b> could be the HTML element that is the subject of the current section of the spec you are testing, assuming you are testing an HTML spec.  If you are testing a different kind of spec, you will need to think of an HTML object that should present the WebIDL in question.  Again, following the architectural parallel, you can imagine this part as the Empire State Building - an actual skyscraper.</p>

<p>All three of these pieces will be used within your WebIDL test.</p> 

<h2>Necessary Files</h2>

<p>First, make sure that you have the necessary <a href="https://github.com/w3c/testharness.js/blob/master/idlharness.js"><kbd>idlharness.js</kbd></a> and <a href="https://github.com/darobin/webidl2.js/blob/develop/lib/webidl2.js"><kbd>webidl2.js</kbd></a> files in your <kbd>resources</kbd> folder.</p>

<p>Then, get a <a href="templates/template-webIDL.html">WebIDL test template</a>.  Go ahead and update the <code>&lt;head&gt;</code> with your metadata and the first <code>&lt;p&gt;</code> element with a note about the scope of this WebIDL test, and save it locally as <b><kbd>sectionname_WebIDL.html</kbd></b>.</p>

<p>Look at the script at the bottom of the file.  You'll note that it's basically four lines of code:</p>

<pre>
idl_array.add_idls(...);
idl_array.add_untested_idls(...);
idl_array.add_objects(...);
idl_array.run_tests();
</pre>

<p>The first line registers the <b>WebIDL to test</b> - the WebIDL that you just found in the section of the spec that you are testing.  Each interface registered here will be checked against the user agent's version of that interface, making sure that the user agent's definition of that interface matches the spec's definition.  Referring back to our architectural parallel, this step lists which blueprints need to be checked against the user agent's version, making sure that the blueprints match -- that the builders work from the same plan as the architect while they build the outside of the skyscraper.</p> 

<p>The second line registers all of the WebIDL that <em>supports</em> the WebIDL we are going to check, the <b>WebIDL not to test</b> as mentioned above.  By putting that WebIDL here, we will have the complete set of correct interfaces for when we evaluate the sample object, but we will not run any tests to check the user agent's internal implementation of those interfaces.  We assume that those interfaces have already been checked elsewhere.  Referring back to the architectural parallel, in this step, the architect maintains a complete portfolio of all the other blueprints that had been needed to build a skyscraper, but the blueprints the engineers had used to build the now-finished inside of the skyscraper have been thrown away.</p>

<p>The third line gets ready to check if each HTML object listed here was implemented according to ALL the WebIDL previously provided.  At least one actual variable, one <b>sample object</b>, needs to be listed for every interface provided in the WebIDL being tested.  That object is itself going to be tested at EVERY layer to make sure that it was implemented according to ALL of the WebIDL provided, "tested" AND "untested".  Again, if we relate this to an architectural project, think of this as the final quality-control check to make sure that the Empire State Building was truly built according to ALL OF the architect's plans, inside AND out.</p>

<p>The fourth line goes ahead and runs all of those tests - first checking that the user agent has the correct plan for each tested interface, and then checking that the HTML object correctly implements that interface (and all the interfaces supporting that interface).</p>

<p>Thanks to <code>idlharness.js</code>, you already have all the JavaScript code you're going to need.  Your role is to add a little HTML if you have to, and then track down all of the needed WebIDL.</p>

<h2>First Piece:  the HTML sample object</h2>

<p>If you are testing an HTML spec, this part is very easy:  it's whatever object the WebIDL is being used to describe.  :-)  Otherwise, you will need to think of an HTML object that should incarnate the WebIDL you're about to test.</p>

<p>If the object is already part of the template (for example, performance tests that use the document object itself), you don't need to add any HTML after all.  You can just refer to what is already there.</p>

<p>If you do need to add a particular HTML element (for example, you are testing the WebIDL interface <code>HTMLHeadingElement</code> and need to add headings, levels 1-6), you can insert that HTML into the <code>&lt;div style='display:none'&gt;</code> element towards the top of the page.</p>

<pre>

&lt;div style='display:none'&gt;

    &lt;h1 id="test_h1"&gt;Test This&lt;/h1&gt;
    &lt;h2 id="test_h2"&gt;Test This&lt;/h2&gt;
    &lt;h3 id="test_h3"&gt;Test This&lt;/h3&gt;
    &gt;h4 id="test_h4"&gt;Test This&lt;/h4&gt;
    &lt;h5 id="test_h5"&gt;Test This&lt;/h5&gt;
    &lt;h6 id="test_h6"&gt;Test This&lt;/h6&gt;

&lt;/div&gt;

</pre>

<h2> Second Piece: the WebIDL to test</h2>

<p>Next, copy and paste the WebIDL you need to test into the <code>&lt;pre id='idl'&gt;</code> element, located right after the HTML-containing div.  This is the WebIDL that is right in front of you as you look at the section of the spec that you are testing.  For example, if you are testing HTML's <code>&lt;h1&gt;...&lt;h6&gt;</code> elements, you will see:</p>

<pre class="idl">

interface HTMLHeadingElement : HTMLElement {};

</pre>

<p>This is going to be your "tested" WebIDL, and you will have simply:</p>

<pre>

&lt;pre id='idl'&gt;

    interface HTMLHeadingElement : HTMLElement {};

&lt;/pre&gt;

</pre> 

<p>Then, within the final <code>&lt;script&gt;</code> element, complete the dictionary required by the <code>idl_array.add_objects</code> method.</p>
<ul>
    <li>Provide your WebIDL interface name(s) and the hook(s) to the HTML object(s) you need for each interface, using whichever approach works best for you.</li>
    <li>Remember to clean out any unneeded template remnants.</li>
</ul>

<pre>

idl_array.add_objects({
    HTMLHeadingElement: ["document.getElementById('test_h1')",
                         "document.getElementById('test_h2')",
                         "document.getElementById('test_h3')",
                         "document.getElementById('test_h4')",
                         "document.getElementById('test_h5')",
                         "document.getElementById('test_h6')"]
});

</pre>

<h2>Third Piece: the WebIDL not to test</h2>

<p>The WebIDL that you want to test probably relies on other WebIDL definitions that were defined elsewhere. Finding it all is quite a detective trail process.  Some definitions may be within the same spec, but others may be in somewhere in a DOM spec, yet others in a CSS spec.... You'll need to track down the WebIDL for each and every one of these underlying definitions, all the way to the end of each trail.</p>

<p>And it's not just the inheritance trail that you need to follow. Watch out for any attributes and methods within each WebIDL definition - they may also refer to types having their own WebIDL definitions.</p>

<p>Luckily, you can click on each term within the WebIDL definition to follow the WebIDL trail.</p>

<p>Still, because you need to track down the WebIDL for every single term that has a WebIDL definition, this step requires multiple copy and pastes from multiple specs.  And some of the WebIDL out there is not yet supported by <code>idlharness.js</code>, meaning the code can choke on it and result in zero tests.</p>  

<p>So, try to organize the WebIDL definitions so that you can trace back through the tree as easily as possible.  Debugging often consists of providing "dummy" blank interfaces for certain definitions, and gradually adding in the full tree.   Let's go through that process.</p>

<h3>COPY, PASTE, RUN... REPEAT</h3>

<p>Look at the WebIDL you have in your first, <b>WebIDL to test</b> section.  What other definitions will you need to fill in the <b>WebIDL not to test</b> section?</p>

<pre>

&lt;pre id='idl'&gt;

    interface HTMLHeadingElement : HTMLElement {};

&lt;/pre&gt;

</pre> 

<p>In this example, it's pretty simple:  just <code>HTMLElement</code> so far. Click on <code>HTMLElement</code> in the spec, and you'll be brought to:</p>

<pre>

interface HTMLElement : Element {
  // metadata attributes
           attribute DOMString title;
           attribute DOMString lang;
           attribute boolean translate;
           attribute DOMString dir;
  readonly attribute DOMStringMap dataset;


  // user interaction
           attribute boolean hidden;
  void click();
           attribute long tabIndex;
  void focus();
  void blur();
           attribute DOMString accessKey;
  readonly attribute DOMString accessKeyLabel;
           attribute boolean draggable;
  [PutForwards=value] readonly attribute DOMSettableTokenList dropzone;
           attribute DOMString contentEditable;
  readonly attribute boolean isContentEditable;
           attribute HTMLMenuElement? contextMenu;
           attribute boolean spellcheck;

  // command API
  readonly attribute DOMString? commandType;
  readonly attribute DOMString? commandLabel;
  readonly attribute DOMString? commandIcon;
  readonly attribute boolean? commandHidden;
  readonly attribute boolean? commandDisabled;
  readonly attribute boolean? commandChecked;

  // styling
  readonly attribute CSSStyleDeclaration style;

  // event handler IDL attributes
           attribute EventHandler onabort;
           attribute EventHandler onblur;
           attribute EventHandler oncancel;
           attribute EventHandler oncanplay;
           attribute EventHandler oncanplaythrough;
           attribute EventHandler onchange;
           attribute EventHandler onclick;
           attribute EventHandler onclose;
           attribute EventHandler oncontextmenu;
           attribute EventHandler oncuechange;
           attribute EventHandler ondblclick;
           attribute EventHandler ondrag;
           attribute EventHandler ondragend;
           attribute EventHandler ondragenter;
           attribute EventHandler ondragleave;
           attribute EventHandler ondragover;
           attribute EventHandler ondragstart;
           attribute EventHandler ondrop;
           attribute EventHandler ondurationchange;
           attribute EventHandler onemptied;
           attribute EventHandler onended;
           attribute OnErrorEventHandler onerror;
           attribute EventHandler onfocus;
           attribute EventHandler oninput;
           attribute EventHandler oninvalid;
           attribute EventHandler onkeydown;
           attribute EventHandler onkeypress;
           attribute EventHandler onkeyup;
           attribute EventHandler onload;
           attribute EventHandler onloadeddata;
           attribute EventHandler onloadedmetadata;
           attribute EventHandler onloadstart;
           attribute EventHandler onmousedown;
           attribute EventHandler onmousemove;
           attribute EventHandler onmouseout;
           attribute EventHandler onmouseover;
           attribute EventHandler onmouseup;
           attribute EventHandler onmousewheel;
           attribute EventHandler onpause;
           attribute EventHandler onplay;
           attribute EventHandler onplaying;
           attribute EventHandler onprogress;
           attribute EventHandler onratechange;
           attribute EventHandler onreset;
           attribute EventHandler onscroll;
           attribute EventHandler onseeked;
           attribute EventHandler onseeking;
           attribute EventHandler onselect;
           attribute EventHandler onshow;
           attribute EventHandler onstalled;
           attribute EventHandler onsubmit;
           attribute EventHandler onsuspend;
           attribute EventHandler ontimeupdate;
           attribute EventHandler onvolumechange;
           attribute EventHandler onwaiting;
};

</pre>

<p>Holy Cow!!</p>

<p>So, let's take this in steps.</p>

<p>Put the whole IDL definition for HTMLElement into the <code>&lt;pre id='pending' style='display:none'&gt;</code> element for now, and just add some "dummy" WebIDL into the <code>&lt;pre id='untested_idl' style='display:none'&gt;</code> element to provide the minimum amount of inheritance information, like this:

<pre>

&lt;pre id='untested_idl' style='display:none'&gt;

interface HTMLElement : Element {};

&lt;pre&gt;

</pre>

<p>Then, back in the spec, click on <code>Element</code> to get to its definition.</p>

<p>This leads us to a reference to the DOM spec.  Go ahead and find the latest draft of the <a href= "http://www.w3.org/TR/domcore/">Dom CORE</a>, and find the section titled <a href="http://www.w3.org/TR/domcore/#interface-element">Interface Element</a>.  This yields:</p>

<pre>

interface Element : Node {
  readonly attribute DOMString? namespaceURI;
  readonly attribute DOMString? prefix;
  readonly attribute DOMString localName;
  readonly attribute DOMString tagName;

           attribute DOMString id;
           attribute DOMString className;
  readonly attribute DOMTokenList classList;

  readonly attribute Attr[] attributes;
  DOMString? getAttribute(DOMString name);
  DOMString? getAttributeNS(DOMString? namespace, DOMString localName);
  void setAttribute(DOMString name, DOMString value);
  void setAttributeNS(DOMString? namespace, DOMString name, DOMString value);
  void removeAttribute(DOMString name);
  void removeAttributeNS(DOMString? namespace, DOMString localName);
  boolean hasAttribute(DOMString name);
  boolean hasAttributeNS(DOMString? namespace, DOMString localName);

  HTMLCollection getElementsByTagName(DOMString localName);
  HTMLCollection getElementsByTagNameNS(DOMString? namespace, DOMString localName);
  HTMLCollection getElementsByClassName(DOMString classNames);

  readonly attribute HTMLCollection children;
  readonly attribute Element? firstElementChild;
  readonly attribute Element? lastElementChild;
  readonly attribute Element? previousElementSibling;
  readonly attribute Element? nextElementSibling;
  readonly attribute unsigned long childElementCount;

  // NEW
  void prepend((Node or DOMString)... nodes);
  void append((Node or DOMString)... nodes);
  void before((Node or DOMString)... nodes);
  void after((Node or DOMString)... nodes);
  void replace((Node or DOMString)... nodes);
  void remove();
};

</pre>

<p>Again, put all of this at the end of the <code>&lt;pre id='pending' style='display:none'&gt;</code> element for now, and just add <code>interface Element : Node {};</code> into the <code>&lt;pre id='untested_idl' style='display:none'&gt;</code> element.  Then, track down <code>Node</code>.  Et cetera.</p>

<p>Eventually, you will have <b>WebIDL not to test</b> that looks like this:</p>

<pre>

&lt;pre id='untested_idl' style='display:none'&gt;
    
    interface HTMLElement : Element {};
    interface Element : Node {};
    interface Node : EventTarget {};
    interface EventTarget {};

&lt;/pre&gt;

</pre>

<p>along with a whole lot of WebIDL to parse in the <code>&lt;pre id='pending' style='display:none'&gt;</code> element.<p>

<p>Load your test in a browser or three just to check that it works.</p>

<p>Now, go ahead and replace the dummy <code>interface HTMLElement : Element {};</code> with the real thing, moving the real definition out of 'pending'.  However, look inside the real definition when you do that, and you'll see that it contains refererences to a bunch of things that have their own WebIDL definitions:  <code>DOMStringMap</code>, <code>DOMSettableTokenList</code>, <code>HTMLMenuElement</code>, <code>CSSStyleDeclaration</code>, <code>EventHandler</code>, and <code>OnErrorEventHandler</code>.</p> 

<p>For each of those terms, do the same thing:  click on the term, grab the real WebIDL definition for the term and put it at the bottom of the 'pending' section (going from spec to spec as you have to), and put a dummy placeholder at the bottom of the 'untested_idl' section.</p>  

<p>Once you have all the dummies in place for all the bits of <code>HTMLElement</code>, go ahead and run your test again.  If the code chokes and you get zero tests, go through the WebIDL, commenting blocks out, trying it again, until you isolate the problem line(s).  Make sure to comment each commented-out problem line, too, so that they'll be easy to find later.</p>

<p>Then, fill in the dummies that you'd had to add for the bits of <code>HTMLElement</code> (<code>DOMStringMap</code>, <code>DOMSettableTokenList</code>, <code>HTMLMenuElement</code>, <code>CSSStyleDeclaration</code>, <code>EventHandler</code>, and <code>OnErrorEventHandler</code>) in the same way, tracking each one down through all its branches, and running the test between each dummy to make sure there's no WebIDL the idlharness can't handle.</p>

<p>When all the subbranches of <code>HTMLELement</code> are done, you are ready to do the same thing for <code>Element</code> (which, looking above, will need dummies for <code>DOMTokenList</code>, <code>Attr</code>, and <code>HTMLCollection</code>).  And then <code>Node</code>.  And then <code>EventTarget</code>.</p>

<p>OK, you have all the WebIDL you need inside of the <code>&lt;pre id='untested_idl' style='display:none'&gt;</code> element?  Then delete the remnants of that placeholder <code>&lt;pre id='pending' style='display:none'&gt;</code> element, and you're done!</p>

<p>Now you can get to the other stuff in this section that needs testing, hopefully by writing some <a href="ExampleTest_Auto.html">JavaScript of your own</a>. :-)</p>

<p>Just remember -- if you <em>did</em> have to comment out any WebIDL for the code to run, make sure you make a careful, detailed note of that both within the file (in the HTML side that is visible to an end-user, too) and in the comments of your future Pull Request.</p>

    <nav>
        <a href="index.html">Back to Overview</a>
        <a href="ExampleTest_Auto.html">Example JavaScript Test</a>
    </nav> 

</div>
</body>
</html>

